<!DOCTYPE html>
<html>
<head>
  <link rel="shortcut icon" href="icon.ico">
<meta charset=utf-8 />
<title>HOT Global Footprint</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-hash/v0.2.1/leaflet-hash.js'></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />
<div id='map'></div>
<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>

<script>

L.mapbox.accessToken = 'pk.eyJ1IjoicHJhdGlreWFkYXYiLCJhIjoiMTA2YWUxNjRkNmFmZGQ4YzAxZWFiNDk0NDM1YjE1YjAifQ.4P6N5dNmA_WQXd3BsJvu5w';
var map = L.mapbox.map('map', null, {
      maxZoom: 18
  }).setView([22.76, -25.84], 3);
  var layers = {
      HOT: L.mapbox.tileLayer('pratikyadav.10e30e60'),
      Streets: L.mapbox.tileLayer('mapbox.streets'),
      Satellite: L.mapbox.tileLayer('mapbox.satellite')
  };
  layers.HOT.addTo(map);
  L.control.layers(layers).addTo(map);


// As with any other AJAX request, this technique is subject to the Same Origin Policy:
// http://en.wikipedia.org/wiki/Same_origin_policy
// So the CSV file must be on the same domain as the Javascript, or the server
// delivering it should support CORS.
//var geojson = L.loadURL('tasks.geojson');


var myLayer = L.mapbox.featureLayer()
    //.bindPopup('<button class="trigger">Say hi</button>');
    .loadURL('tasks.geojson');
    //.addTo(map);
//markers.addLayer(featureLayer);
// The HTML we put in bindPopup doesn't exist yet, so we can't just say
// $('#mybutton'). Instead, we listen for click events on the map element which
// will bubble up from the tooltip, once it's created and someone clicks on it.
//$('#map').on('click', '.trigger', function() {
    //alert('Hello from Toronto!');
//});
//var markers = new L.MarkerClusterGroup();


var markers = new L.MarkerClusterGroup();

myLayer.on('layeradd', function(e) {
    var marker = e.layer,
        feature = marker.feature;


    // Create custom popup content
    var taskno = feature.properties.changeset_;
    var popupContent;
    console.log(taskno);

    try{
      var url = feature.properties.changeset_.match(/(task)*(project)*-\d+/g)[0].split('-')[1];
      popupContent = '<center><h1> <a href="http://tasks.hotosm.org/project/' + url + '">' + taskno + '</a> </center></h1>'
    }
    catch(err){
      popupContent = '<center><h1>' + taskno + '</center></h1>'
    }

    // http://leafletjs.com/reference.html#popup
    marker.bindPopup(popupContent,{
        closeButton: false,
        minWidth: 320
    });


    markers.addLayer(myLayer).addTo(map);

});

// Add features to the map
//myLayer.setGeoJSON(map);


var hash = L.hash(map);
</script>
</body>
</html>
